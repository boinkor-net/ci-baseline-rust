name: "Tests for this repo"
on:
  workflow_call:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  success_tests:
    strategy:
      matrix:
        rust_toolchain: ["stable", "nightly"]
    uses: "./.github/workflows/ci_baseline_rust_tests.yml"
    with:
      cargo_test_args: "--manifest-path tests/success/Cargo.toml"
      rust_toolchain: ${{ matrix.rust_toolchain }}

  failure_tests:
    strategy:
      matrix:
        rust_toolchain: ["stable", "nightly"]
    uses: "./.github/workflows/ci_baseline_rust_tests.yml"
    with:
      cargo_test_args: "--manifest-path tests/failure/Cargo.toml"
      rust_toolchain: ${{ matrix.rust_toolchain }}

  failure_tests_result:
    runs-on: ubuntu-latest
    permissions:
      actions: read
    needs:
      - failure_tests
    if: always()
    steps:
      - uses: martialonline/workflow-status@v4
        id: check
      - name: "any jobs succeeded - that's not what we want"
        if: steps.check.outputs.status == 'success'
        run: false

  all_failure_tests:
    runs-on: ubuntu-latest
    needs:
      - failure_tests_result
    steps: [{ run: "true" }]
